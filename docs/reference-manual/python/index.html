

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>44. truchas Python Module &mdash; Truchas Reference Manual 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=93b25530" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script>window.MathJax = {"chtml": {"displayAlign": "left", "displayIndent": "2em"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="PATCHES Namelist (Expert Options)" href="../rade/PATCHES_Namelist_Expert_Options.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Truchas Reference Manual
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BODY_Namelist/index.html">2. BODY Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../complex_function_namelist.html">3. COMPLEX_FUNCTION Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../complex_vfunction_namelist.html">4. COMPLEX_VFUNCTION Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DIFFUSION_Solver_Namelist/index.html">5. DIFFUSION Solver Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ELECTROMAGNETIC_BC_Namelist/index.html">6. ELECTROMAGNETIC_BC Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../EM_MESH_Namelist/index.html">7. EM_MESH Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ENCLOSURE_RADIATION_Namelist/index.html">8. ENCLOSURE_RADIATION Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ENCLOSURE_SURFACE_Namelist/index.html">9. ENCLOSURE_SURFACE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../EVAPORATION_Namelist/index.html">10. EVAPORATION Namelist (Experimental)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fdme_solver_namelist.html">11. FDME_SOLVER Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FLOW_Namelist/index.html">12. FLOW Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FLOW_BC_Namelist/index.html">13. FLOW_BC Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FLOW_PRESSURE_SOLVER_and_FLOW_VISCOUS_SOLVER_Namelists/index.html">14. FLOW_PRESSURE_SOLVER and FLOW_VISCOUS_SOLVER Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FUNCTION_Namelist/index.html">15. FUNCTION Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../induction_heating_namelist.html">16. INDUCTION_HEATING Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../INDUCTION_SOURCE_FIELD_Namelist/index.html">17. INDUCTION_SOURCE_FIELD Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MATERIAL_and_PHASE_Namelists/index.html">18. MATERIAL and PHASE Namelists</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MESH_Namelist/index.html">19. MESH Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MICROSTRUCTURE_Namelist/index.html">20. MICROSTRUCTURE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../microwave_heating_namelist.html">21. MICROWAVE_HEATING Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NUMERICS_Namelist/index.html">22. NUMERICS Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTPUTS_Namelist/index.html">23. OUTPUTS Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PHASE_CHANGE_Namelist/index.html">24. PHASE_CHANGE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PHYSICAL_CONSTANTS_Namelist/index.html">25. PHYSICAL_CONSTANTS Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PHYSICS_Namelist/index.html">26. PHYSICS Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PROBE_Namelist/index.html">27. PROBE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RESTART_Namelist/index.html">28. RESTART Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SIMULATION_CONTROL_Namelist/index.html">29. SIMULATION_CONTROL Namelist (Experimental)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOLID_MECHANICS_Namelist/index.html">30. SOLID_MECHANICS Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOLID_MECHANICS_BC_Namelist/index.html">31. SOLID_MECHANICS_BC Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPECIES_BC_Namelist/index.html">32. SPECIES_BC Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SPECIES_SOURCE_Namelist/index.html">33. SPECIES_SOURCE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tdme_joule_solver_namelist.html">34. TDME_JOULE_SOLVER Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../THERMAL_BC_Namelist/index.html">35. THERMAL_BC Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../THERMAL_SOURCE_Namelist/index.html">36. THERMAL_SOURCE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TOOLHEAD_Namelist/index.html">37. TOOLHEAD Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TOOLPATH_Namelist/index.html">38. TOOLPATH Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TURBULENCE_Namelist/index.html">39. TURBULENCE Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VFUNCTION_Namelist/index.html">40. VFUNCTION Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VISCOPLASTIC_MODEL_Namelist/index.html">41. VISCOPLASTIC_MODEL Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VISCOPLASTIC_SOLVER_Namelist/index.html">42. VISCOPLASTIC_SOLVER Namelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rade/index.html">43. Radiation Enclosure Tools</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">44. <code class="docutils literal notranslate"><span class="pre">truchas</span></code> Python Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#examples">44.1. Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-restart">Custom Restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimization">Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameter-study">Parameter Study</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#components">44.2. Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#truchasenvironment">TruchasEnvironment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#truchasdata">TruchasData</a></li>
<li class="toctree-l3"><a class="reference internal" href="#truchasmappeddata">TruchasMappedData</a></li>
<li class="toctree-l3"><a class="reference internal" href="#truchasstudy">TruchasStudy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#truchasdatabase">TruchasDatabase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#truchastest">TruchasTest</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Truchas Reference Manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">44. </span><code class="docutils literal notranslate"><span class="pre">truchas</span></code> Python Module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/python/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="truchas-python-module">
<h1><span class="section-number">44. </span><code class="docutils literal notranslate"><span class="pre">truchas</span></code> Python Module<a class="headerlink" href="#truchas-python-module" title="Link to this heading"></a></h1>
<p>Truchas provides a Python package for scripting. This is useful for generating
custom restarts, performing automated optimization, and performing automated
parameter studies, or computing custom metrics.</p>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#examples" id="id1">Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-restart" id="id2">Custom Restart</a></p></li>
<li><p><a class="reference internal" href="#optimization" id="id3">Optimization</a></p></li>
<li><p><a class="reference internal" href="#parameter-study" id="id4">Parameter Study</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#components" id="id5">Components</a></p>
<ul>
<li><p><a class="reference internal" href="#truchasenvironment" id="id6">TruchasEnvironment</a></p></li>
<li><p><a class="reference internal" href="#truchasdata" id="id7">TruchasData</a></p></li>
<li><p><a class="reference internal" href="#truchasmappeddata" id="id8">TruchasMappedData</a></p></li>
<li><p><a class="reference internal" href="#truchasstudy" id="id9">TruchasStudy</a></p></li>
<li><p><a class="reference internal" href="#truchasdatabase" id="id10">TruchasDatabase</a></p></li>
<li><p><a class="reference internal" href="#truchastest" id="id11">TruchasTest</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="examples">
<h2><a class="toc-backref" href="#id1" role="doc-backlink"><span class="section-number">44.1. </span>Examples</a><a class="headerlink" href="#examples" title="Link to this heading"></a></h2>
<section id="custom-restart">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">Custom Restart</a><a class="headerlink" href="#custom-restart" title="Link to this heading"></a></h3>
<p>Frequently it is necessary to generate custom mapped restarts. For example, if
we need to map data to a new mesh, where there is a new block which needs to be
initialized. Generally, we will need to initialize this block with a material
and a temperature. The below script shows how to read in a Truchas h5 file, map
it to a new mesh, and modify some field data before generating a restart file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">truchas</span>

<span class="c1"># Load truchas data from the preheat run, map it to a new mesh, and scale that mesh.</span>
<span class="n">tdata</span> <span class="o">=</span> <span class="n">truchas</span><span class="o">.</span><span class="n">TruchasMappedData</span><span class="p">(</span><span class="s2">&quot;preheat_output/preheat.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;mesh2.gen&quot;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

<span class="c1"># Select the last cycle in the preheat output. Further calls will read data from</span>
<span class="c1"># this cycle, overwrite data at this cycle, and generate a restart with our</span>
<span class="c1"># modifications.</span>
<span class="n">sid</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">.</span><span class="n">num_series</span><span class="p">()</span>

<span class="c1"># Set the VOF to [0, 1] (purely the final material in the input) in block 2</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">assign_value_block</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">assign_value_block</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Compute the function f = 1 + 2*x at cell centers across the mesh.</span>
<span class="n">xc</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">.</span><span class="n">centroids</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Reassign the temperature to the function f, but only in blocks 1 and 3.</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">assign_value_block</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Alternatively, we could read the whole field and modify it before reassigning.</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">)</span>
<span class="n">graphite_region</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">temp</span><span class="p">[</span><span class="n">graphite_region</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">graphite_region</span><span class="p">]</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">assign_field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>

<span class="c1"># Alternatively, we could use Numpy functions</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdata</span><span class="o">.</span><span class="n">blockid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">tdata</span><span class="o">.</span><span class="n">blockid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">assign_field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>

<span class="c1"># Write the custom restart file</span>
<span class="n">tdata</span><span class="o">.</span><span class="n">write_restart</span><span class="p">(</span><span class="s2">&quot;preheat.restart&quot;</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
</pre></div>
</div>
<p><sup>Example Truchas Python script. This script reads a Truchas output file, generates a mapped restart onto a new mesh, and overwrites data for some variables on a specific block on that new mesh.</sup></p>
</section>
<section id="optimization">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Optimization</a><a class="headerlink" href="#optimization" title="Link to this heading"></a></h3>
<p>Python scripting can be used to execute Truchas in a loop, for example to modify
some heat flux boundary condition until the temperature at some point in the
mesh fits an expected value. We can wrap this entire process into a Python
function, then use an optimization function from the popular Scipy package to
solve <span class="math notranslate nohighlight">\(T(F) = 500\)</span> for the temperature <span class="math notranslate nohighlight">\(T\)</span> at <span class="math notranslate nohighlight">\(x = (0, 0, 0)\)</span>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...

&amp;PROBE
  coord = 0, 0, 0
  data = &#39;temperature&#39;
  data_file = &#39;top-temperature.txt&#39;
/

...

&amp;THERMAL_BC
  name = &#39;heat-coil&#39;
  face_set_ids = 14
  type = &#39;flux&#39;
  flux = -{heat_flux:.4e} ! [W / m^2]
/

...
</pre></div>
</div>
<p><sup>Part of a Truchas template input, here named template-heatup.inp. The text {heat_flux:.4e} will be replaced by the Python-generated input deck below.</sup></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">spopt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">truchas</span>

<span class="k">def</span><span class="w"> </span><span class="nf">final_top_temperature</span><span class="p">(</span><span class="n">heat_flux</span><span class="p">,</span> <span class="n">tenv</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">):</span>
    <span class="c1"># Generate input deck</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;heat_flux&quot;</span><span class="p">:</span> <span class="n">heat_flux</span><span class="p">}</span>
    <span class="n">tenv</span><span class="o">.</span><span class="n">generate_input_deck</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;template-heatup.inp&quot;</span><span class="p">,</span> <span class="s2">&quot;heatup.inp&quot;</span><span class="p">)</span>

    <span class="c1"># Run truchas with the new input</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">tenv</span><span class="o">.</span><span class="n">truchas</span><span class="p">(</span><span class="n">nprocs</span><span class="p">,</span> <span class="s2">&quot;block-heatup.inp&quot;</span><span class="p">)</span>

    <span class="c1"># Read the temperature probe</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">probe_data</span><span class="p">(</span><span class="s2">&quot;top-temperature.txt&quot;</span><span class="p">)</span>

    <span class="c1"># It is useful to print both the input and output for every iteration,</span>
    <span class="c1"># since each iteration is a full simulation and can be slow.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;heat_flux = </span><span class="si">{</span><span class="n">heat_flux</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, temperature = </span><span class="si">{</span><span class="n">temperature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return the last element (final time) of the second column (temperature column)</span>
    <span class="k">return</span> <span class="n">temperature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">nprocs</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># We need to allow overwriting the output directory, since each iteration of</span>
    <span class="c1"># the optimizer will re-run Truchas.</span>
    <span class="n">tenv</span> <span class="o">=</span> <span class="n">truchas</span><span class="o">.</span><span class="n">TruchasEnvironment</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">overwrite_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># We&#39;ll wrap our function final_top_temperature in a lambda, so we can pass</span>
    <span class="c1"># in the TruchasEnvironment and nprocs variables. We&#39;ll also offset by our</span>
    <span class="c1"># target value, since we&#39;re using a root finder.</span>
    <span class="n">fx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">final_top_temperature</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tenv</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">500</span>

    <span class="c1"># The Scipy.Optimize.brentq root finder is used. Here we&#39;re passing our</span>
    <span class="c1"># lambda, an interval for our heat flux of [2.5e4, 5e4], a tolerance of 50</span>
    <span class="c1"># K, and absolute and relative tolerances on the heat flux.</span>
    <span class="n">heat_flux</span> <span class="o">=</span> <span class="n">spopt</span><span class="o">.</span><span class="n">brentq</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="mf">2.5e4</span><span class="p">,</span> <span class="mf">5e4</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">heat_flux</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="parameter-study">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Parameter Study</a><a class="headerlink" href="#parameter-study" title="Link to this heading"></a></h3>
<p>Suppose we wish to perform the following parameter study: Vary the heat flux on
one boundary condition, and measure the maximum and average temperature in block
1. The following script will define the custom output metrics (max and avg
temperature on block 1), the parameter dictionary, and perform the parameter
study. This will produce a text file <cite>vary_heat_flux.txt</cite> which contains a table
with the input and output values.</p>
<p>This script will also generate a database which caches Truchas outputs. This way,
if we re-run the parameter study with more heat flux values later, we don’t need
to re-run entire simulations which have already been computed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">truchas</span>


<span class="c1"># read the maximum temperature in block 1</span>
<span class="k">def</span><span class="w"> </span><span class="nf">max_temperature_str</span><span class="p">(</span><span class="n">input_parameters</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">num_series</span><span class="p">()</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">)</span>
    <span class="n">block1</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_temperature</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">block1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max temperature = </span><span class="si">{</span><span class="n">max_temperature</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> K.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">max_temperature</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># compute the average temperature in block 1</span>
<span class="k">def</span><span class="w"> </span><span class="nf">avg_temperature_str</span><span class="p">(</span><span class="n">input_parameters</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">num_series</span><span class="p">()</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;Z_TEMP&quot;</span><span class="p">)</span>
    <span class="n">cell_volume</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">volumes</span><span class="p">()</span>
    <span class="n">block1</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">avg_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">block1</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">cell_volume</span><span class="p">[</span><span class="n">block1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg temperature = </span><span class="si">{</span><span class="n">avg_temp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> K.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_tmp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Store the results from each run in a database. If we wish to run this</span>
    <span class="c1"># parameter study again with additional points, each run will be cached so</span>
    <span class="c1"># we don&#39;t need to re-run data we&#39;ve already calculated.</span>
    <span class="n">nproc</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">tenv</span> <span class="o">=</span> <span class="n">truchas</span><span class="o">.</span><span class="n">TruchasEnvironment</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">overwrite_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tdb</span> <span class="o">=</span> <span class="n">truchas</span><span class="o">.</span><span class="n">TruchasDatabase</span><span class="p">(</span><span class="s2">&quot;parameter_study&quot;</span><span class="p">)</span>
    <span class="n">tstudy</span> <span class="o">=</span> <span class="n">truchas</span><span class="o">.</span><span class="n">TruchasStudy</span><span class="p">(</span><span class="n">tenv</span><span class="p">,</span> <span class="n">tdb</span><span class="p">,</span> <span class="n">nproc</span><span class="p">)</span>

    <span class="c1"># Suppose the template file has multiple values that need to be inserted,</span>
    <span class="c1"># but we&#39;re only doing a parameter study on &quot;heat_flux2&quot;.</span>
    <span class="n">input_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;heat_flux1&quot;</span><span class="p">:</span> <span class="mf">4e4</span><span class="p">,</span>
                        <span class="s2">&quot;heat_flux2&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
                        <span class="p">}</span>
    <span class="n">heat_flux2_points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e4</span><span class="p">,</span> <span class="mf">2e4</span><span class="p">,</span> <span class="mf">4e4</span><span class="p">]</span>

    <span class="c1"># The output will be a text file with the following columns: &quot;heat_flux2&quot;,</span>
    <span class="c1"># &quot;max_temperature&quot;, and &quot;average_temperature&quot;. The latter two are custom</span>
    <span class="c1"># output metrics, tied to functions defined above.</span>
    <span class="n">output_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;max_temperature&quot;</span><span class="p">:</span> <span class="n">max_temperature_str</span><span class="p">,</span>
                      <span class="s2">&quot;average_temperature&quot;</span><span class="p">:</span> <span class="n">avg_temperature_str</span><span class="p">,</span>
                      <span class="p">}</span>

    <span class="n">tstudy</span><span class="o">.</span><span class="n">do_1d_parameter_study</span><span class="p">(</span><span class="s2">&quot;template-heatup.inp&quot;</span><span class="p">,</span>
                                 <span class="n">input_parameters</span><span class="p">,</span> <span class="s2">&quot;heat_flux2&quot;</span><span class="p">,</span> <span class="n">heat_flux2_points</span><span class="p">,</span>
                                 <span class="n">output_metrics</span><span class="p">,</span> <span class="s2">&quot;vary_heat_flux.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="components">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">44.2. </span>Components</a><a class="headerlink" href="#components" title="Link to this heading"></a></h2>
<section id="truchasenvironment">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">TruchasEnvironment</a><a class="headerlink" href="#truchasenvironment" title="Link to this heading"></a></h3>
</section>
<section id="truchasdata">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">TruchasData</a><a class="headerlink" href="#truchasdata" title="Link to this heading"></a></h3>
</section>
<section id="truchasmappeddata">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">TruchasMappedData</a><a class="headerlink" href="#truchasmappeddata" title="Link to this heading"></a></h3>
</section>
<section id="truchasstudy">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">TruchasStudy</a><a class="headerlink" href="#truchasstudy" title="Link to this heading"></a></h3>
</section>
<section id="truchasdatabase">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">TruchasDatabase</a><a class="headerlink" href="#truchasdatabase" title="Link to this heading"></a></h3>
</section>
<section id="truchastest">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">TruchasTest</a><a class="headerlink" href="#truchastest" title="Link to this heading"></a></h3>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../rade/PATCHES_Namelist_Expert_Options.html" class="btn btn-neutral float-left" title="PATCHES Namelist (Expert Options)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2024, The Truchas Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>